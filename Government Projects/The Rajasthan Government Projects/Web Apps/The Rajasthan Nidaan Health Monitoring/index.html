<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The ChitraHarsha Nidaan 2.0 AI | Commercial Edition</title>
    <meta
      name="description"
      content="AI-Powered Health Monitoring with Netra Lens & Megh-Kosh Cloud."
    />
    <meta name="author" content="The ChitraHarsha VPK Ventures" />

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#003366" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="Nidaan 2.0" />
    <link
      rel="apple-touch-icon"
      href="https://img.icons8.com/fluency/192/medical-heart.png"
    />

    <!-- Security Headers (Meta Tags) -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://firestore.googleapis.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://*.googleapis.com https://*.firebaseio.com wss://*.firebaseio.com; media-src 'self' blob:; frame-src 'none';"
    />
    <meta http-equiv="X-Content-Type-Options" content="nosniff" />
    <meta http-equiv="Referrer-Policy" content="no-referrer" />
    <meta
      http-equiv="Permissions-Policy"
      content="camera=*, microphone=*, geolocation=*"
    />

    <!-- 
        ARCHITECTURAL STANDARDS: "Vastu-Digital v2.0"
        - Compliance: ISO 27001, DPDP Act 2023, WCAG 2.1, ABHA Ready
        - Tech Stack: HTML5, CSS3, Firebase (Firestore, Storage, Auth)
        - Security: AES-256-GCM, MFA, Digital Signatures
        - Features: Voice/Audio Recognition, Image Processing, PWA
    -->
    <style>
      :root {
        /* Brand Identity: ChitraHarsha VPK & Rajasthan Govt */
        --royal-blue: #003366;
        --marwar-gold: #d4af37;
        --saffron-accent: #ff9933;
        --white: #ffffff;
        --bg-offwhite: #f4f6f9;
        --text-dark: #1a202c;
        --text-muted: #718096;

        /* Status System */
        --status-safe: #27ae60;
        --status-warn: #f39c12;
        --status-danger: #c0392b;

        /* Design Tokens */
        --radius-md: 8px;
        --radius-lg: 16px;
        --shadow-subtle: 0 4px 6px rgba(0, 0, 0, 0.05);
        --shadow-elevated: 0 10px 25px rgba(0, 0, 0, 0.1);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      }

      body {
        background-color: var(--bg-offwhite);
        color: var(--text-dark);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* --- 1. VAJRA-KAVACH (Security & Auth Layer) --- */
      #auth-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 51, 102, 0.98);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(8px);
      }
      .auth-card {
        background: white;
        padding: 40px;
        border-radius: var(--radius-lg);
        width: 100%;
        max-width: 480px;
        text-align: center;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        border-top: 6px solid var(--marwar-gold);
        position: relative;
        overflow: hidden;
      }
      .govt-emblem {
        font-size: 3rem;
        margin-bottom: 5px;
        color: var(--royal-blue);
      }
      .auth-btn {
        background: linear-gradient(135deg, var(--royal-blue), #004080);
        color: white;
        border: none;
        padding: 14px;
        width: 100%;
        border-radius: var(--radius-md);
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        margin-top: 20px;
        transition: all 0.2s;
      }
      .auth-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 51, 102, 0.3);
      }
      .auth-btn:disabled {
        background: #cbd5e0;
        cursor: not-allowed;
        transform: none;
      }

      .consent-box {
        text-align: left;
        background: #f8fafc;
        padding: 15px;
        border-radius: var(--radius-md);
        border: 1px solid #e2e8f0;
        margin: 20px 0;
        font-size: 0.85rem;
        color: #4a5568;
      }
      .consent-box input {
        margin-right: 10px;
        transform: scale(1.2);
      }

      /* --- 2. HEADER (Shirshak) --- */
      header {
        background: var(--white);
        border-bottom: 1px solid #e2e8f0;
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: var(--shadow-subtle);
        position: sticky;
        top: 0;
        z-index: 100;
      }
      .brand-section {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      .brand-logo {
        width: 50px;
        height: 50px;
        background: var(--royal-blue);
        color: var(--marwar-gold);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 900;
        border: 3px solid var(--marwar-gold);
        font-size: 1.2rem;
      }
      .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .status-online {
        background: #e6fffa;
        color: var(--status-safe);
        border: 1px solid var(--status-safe);
      }
      .status-offline {
        background: #fff5f5;
        color: var(--status-danger);
        border: 1px solid var(--status-danger);
      }

      .lang-toggle {
        background: transparent;
        border: 1px solid var(--royal-blue);
        color: var(--royal-blue);
        padding: 4px 10px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: bold;
        margin-left: 10px;
      }
      .lang-toggle:hover {
        background: var(--bg-offwhite);
      }

      /* --- 3. NAVIGATION (Disha) --- */
      .nav-bar {
        background: var(--royal-blue);
        display: flex;
        overflow-x: auto;
        padding: 0 1rem;
      }
      .nav-link {
        padding: 16px 24px;
        color: rgba(255, 255, 255, 0.75);
        cursor: pointer;
        font-weight: 500;
        transition: 0.3s;
        border-bottom: 4px solid transparent;
        white-space: nowrap;
      }
      .nav-link:hover {
        color: white;
        background: rgba(255, 255, 255, 0.1);
      }
      .nav-link.active {
        color: white;
        border-bottom-color: var(--marwar-gold);
        background: rgba(255, 255, 255, 0.15);
      }

      /* --- 4. WORKSPACE (Karya-Kshetra) --- */
      .main-container {
        max-width: 1440px;
        margin: 24px auto;
        padding: 0 16px;
        flex: 1;
        width: 100%;
      }
      .grid-system {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 24px;
      }
      .col-8 {
        grid-column: span 8;
      }
      .col-4 {
        grid-column: span 4;
      }
      .col-6 {
        grid-column: span 6;
      }
      .col-12 {
        grid-column: span 12;
      }

      .card {
        background: white;
        border-radius: var(--radius-md);
        padding: 24px;
        box-shadow: var(--shadow-subtle);
        border: 1px solid #edf2f7;
        position: relative;
      }
      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 1px solid #f1f5f9;
      }
      .card-title {
        font-weight: 700;
        color: var(--royal-blue);
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* --- 5. NETRA LENS (Real Camera Intelligence) --- */
      .lens-container {
        position: relative;
        border: 2px dashed #cbd5e0;
        border-radius: var(--radius-md);
        height: 350px;
        background: #000;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        flex-direction: column;
        cursor: pointer;
      }
      .lens-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: transparent;
        z-index: 2;
        pointer-events: none;
      }
      /* Scifi Corners */
      .lens-overlay::before,
      .lens-overlay::after {
        content: "";
        position: absolute;
        width: 30px;
        height: 30px;
        border: 3px solid var(--status-safe);
        transition: all 0.3s;
      }
      .lens-overlay::before {
        top: 20px;
        left: 20px;
        border-right: none;
        border-bottom: none;
      }
      .lens-overlay::after {
        bottom: 20px;
        right: 20px;
        border-left: none;
        border-top: none;
      }

      .scanner-line {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: var(--status-safe);
        box-shadow: 0 0 15px var(--status-safe);
        z-index: 3;
        animation: scanAnim 2s infinite linear;
        display: none;
      }
      @keyframes scanAnim {
        0% {
          top: 10%;
          opacity: 0;
        }
        10% {
          opacity: 1;
        }
        90% {
          opacity: 1;
        }
        100% {
          top: 90%;
          opacity: 0;
        }
      }

      /* The Video Feed */
      #camera-feed {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: 1;
        transform: scaleX(-1); /* Mirror effect */
        display: none;
      }

      .lens-controls {
        z-index: 4;
        text-align: center;
      }
      .lens-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid white;
        color: white;
        padding: 10px 20px;
        border-radius: 30px;
        margin-top: 15px;
        cursor: pointer;
        backdrop-filter: blur(5px);
        transition: 0.2s;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .lens-btn:hover {
        background: white;
        color: black;
      }

      /* --- 6. FORMS & INPUTS --- */
      .input-group {
        margin-bottom: 16px;
      }
      .input-label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        font-size: 0.9rem;
        color: #4a5568;
      }
      .form-control {
        width: 100%;
        padding: 12px;
        border: 1px solid #cbd5e0;
        border-radius: var(--radius-md);
        font-size: 1rem;
        transition: 0.2s;
      }
      .form-control:focus {
        outline: none;
        border-color: var(--royal-blue);
        box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1);
      }

      /* --- 7. FOOTER & COMPLIANCE --- */
      footer {
        background: var(--royal-blue);
        color: white;
        padding: 3rem 1rem;
        margin-top: auto;
        font-size: 0.9rem;
        text-align: center;
      }
      .compliance-badges {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
        flex-wrap: wrap;
      }
      .comp-badge {
        background: rgba(255, 255, 255, 0.1);
        padding: 5px 15px;
        border-radius: 4px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        font-size: 0.8rem;
      }

      /* Utils */
      .hidden {
        display: none !important;
      }
      .btn-primary {
        background: var(--royal-blue);
        color: white;
        padding: 10px 20px;
        border-radius: var(--radius-md);
        border: none;
        cursor: pointer;
        font-weight: 600;
      }
      .pulse-dot {
        width: 8px;
        height: 8px;
        background: red;
        border-radius: 50%;
        animation: pulse 1.5s infinite;
        display: inline-block;
        margin-right: 5px;
      }
      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.4;
        }
        100% {
          opacity: 1;
        }
      }

      @media (max-width: 900px) {
        .grid-system {
          display: flex;
          flex-direction: column;
        }
        .col-8,
        .col-4,
        .col-6 {
          width: 100%;
        }
      }
    </style>

    <!-- Firebase SDKs -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        query,
        orderBy,
        limit,
        onSnapshot,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

      // Global Scope Assignment for our App Logic
      window.firebaseModules = {
        initializeApp,
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
        getFirestore,
        collection,
        addDoc,
        query,
        orderBy,
        limit,
        onSnapshot,
        serverTimestamp,
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL,
      };
    </script>

    <!-- Advanced Feature Modules -->
    <script src="js/encryption.js" defer></script>
    <script src="js/voice-handler.js" defer></script>
    <script src="js/image-handler.js" defer></script>
  </head>
  <body>
    <!-- AUTHENTICATION (VAJRA-KAVACH) -->
    <div id="auth-overlay">
      <div class="auth-card">
        <div class="govt-emblem">üèõÔ∏è</div>
        <h2 style="color: var(--royal-blue); margin-bottom: 5px">
          The ChitraHarsha Nidaan 2.0 AI
        </h2>
        <p style="color: var(--text-muted); font-size: 0.9rem">
          Integrated Health Management System (IHMS)
        </p>

        <div style="text-align: left; margin-top: 25px">
          <div class="input-group">
            <label class="input-label">SSO ID / Jan Aadhaar Number</label>
            <input
              type="text"
              class="form-control"
              id="auth-id"
              placeholder="e.g. RJ-HEALTH-ADMIN"
            />
          </div>

          <!-- COMPLIANCE CHECKBOX -->
          <div class="consent-box">
            <label
              style="display: flex; align-items: flex-start; cursor: pointer"
            >
              <input
                type="checkbox"
                id="consent-check"
                onchange="window.app.toggleAuthBtn()"
              />
              <span>
                I authorize data collection in compliance with
                <strong
                  >Digital Personal Data Protection (DPDP) Act, 2023</strong
                >. I have read and agree to the
                <a
                  href="privacy-policy.html"
                  target="_blank"
                  style="color: var(--royal-blue); text-decoration: underline"
                  >Privacy Policy</a
                >.
              </span>
            </label>
          </div>

          <button
            class="auth-btn"
            id="login-btn"
            onclick="window.app.login()"
            disabled
          >
            Secure Login (SSO)
          </button>
        </div>

        <div style="margin-top: 20px; font-size: 0.75rem; color: #718096">
          Protected by Vajra-Kavach Security.<br />
          Hosted on Rajasthan State Data Centre (SDC).
        </div>
      </div>
    </div>

    <!-- HEADER -->
    <header>
      <div class="brand-section">
        <div class="brand-logo">N2</div>
        <div>
          <h1 style="font-size: 1.25rem; color: var(--royal-blue); margin: 0">
            Nidaan 2.0 AI
          </h1>
          <div
            style="
              font-size: 0.75rem;
              color: var(--text-muted);
              letter-spacing: 0.5px;
            "
          >
            POWERED BY THE CHITRAHARSHA VPK VENTURES
          </div>
        </div>
      </div>
      <div class="brand-section">
        <div id="net-badge" class="status-badge status-online">
          <span class="pulse-dot" style="background: var(--status-safe)"></span>
          <span id="cloud-status-text">Megh-Kosh Active</span>
        </div>
        <button class="lang-toggle" onclick="window.app.toggleLang()">
          ‡§Ö/A
        </button>
      </div>
    </header>

    <!-- NAVIGATION -->
    <nav class="nav-bar">
      <div
        class="nav-link active"
        onclick="window.app.nav('dashboard')"
        id="tab-dash"
      >
        Raj-Darpan (Dashboard)
      </div>
      <div class="nav-link" onclick="window.app.nav('field')" id="tab-field">
        Gramin-Sevak (Field)
      </div>
      <div class="nav-link" onclick="window.app.nav('cloud')" id="tab-cloud">
        Megh-Kosh (Cloud)
      </div>
    </nav>

    <!-- MAIN APP CONTAINER -->
    <main class="main-container">
      <!-- VIEW: DASHBOARD (RAJ-DARPAN) -->
      <div id="view-dashboard" class="grid-system">
        <!-- AI PREDICTOR -->
        <div class="card col-8">
          <div class="card-header">
            <span class="card-title">‚ú® Divya-Drishti Predictive Engine</span>
            <select
              class="form-control"
              style="width: auto; padding: 6px"
              onchange="window.app.updateAI(this.value)"
            >
              <option value="jaipur">Jaipur Zone</option>
              <option value="jodhpur">Jodhpur Zone</option>
              <option value="udaipur">Udaipur Zone</option>
            </select>
          </div>
          <div
            style="
              background: linear-gradient(to right, #eef2f3, #e0eafc);
              padding: 20px;
              border-radius: 8px;
              margin-bottom: 20px;
            "
          >
            <h3 id="prediction-title" style="color: var(--royal-blue)">
              Viral Outbreak Probability: Moderate
            </h3>
            <p style="font-size: 0.9rem; margin-top: 5px">
              Based on historic IHMS data & current climate patterns.
            </p>
          </div>
          <!-- Simulating a Chart -->
          <div
            style="
              display: flex;
              align-items: flex-end;
              height: 180px;
              gap: 15px;
              padding-bottom: 10px;
              border-bottom: 1px solid #eee;
            "
          >
            <div
              class="bar-sim"
              style="
                flex: 1;
                background: #cbd5e0;
                height: 40%;
                border-radius: 4px 4px 0 0;
              "
            ></div>
            <div
              class="bar-sim"
              style="
                flex: 1;
                background: #cbd5e0;
                height: 55%;
                border-radius: 4px 4px 0 0;
              "
            ></div>
            <div
              class="bar-sim"
              style="
                flex: 1;
                background: #cbd5e0;
                height: 45%;
                border-radius: 4px 4px 0 0;
              "
            ></div>
            <div
              class="bar-sim"
              style="
                flex: 1;
                background: var(--royal-blue);
                height: 75%;
                border-radius: 4px 4px 0 0;
                position: relative;
              "
            >
              <span
                style="
                  position: absolute;
                  top: -25px;
                  left: 0;
                  right: 0;
                  text-align: center;
                  font-weight: bold;
                  font-size: 0.8rem;
                  color: var(--royal-blue);
                "
                >Next Wk</span
              >
            </div>
          </div>
          <div
            style="
              margin-top: 15px;
              padding: 10px;
              background: #fff8e1;
              border-left: 4px solid var(--status-warn);
              font-size: 0.9rem;
            "
          >
            <strong>ü§ñ AI Insight:</strong> High humidity in eastern blocks
            suggests a potential rise in Dengue vectors. Recommended Action:
            Fogging in Sector 4.
          </div>
        </div>

        <!-- ALERTS -->
        <div class="card col-4">
          <div class="card-header">
            <span class="card-title">üì¢ Aapat-Kaaleen Alerts</span>
          </div>
          <ul style="list-style: none">
            <li
              style="
                padding: 10px;
                border-bottom: 1px solid #eee;
                display: flex;
                gap: 10px;
              "
            >
              <span style="color: var(--status-danger)">‚ö†Ô∏è</span>
              <div>
                <strong>Malaria Spike</strong><br /><small
                  >Barmer Block B</small
                >
              </div>
            </li>
            <li
              style="
                padding: 10px;
                border-bottom: 1px solid #eee;
                display: flex;
                gap: 10px;
              "
            >
              <span style="color: var(--status-warn)">üì¶</span>
              <div>
                <strong>Low Inventory</strong><br /><small
                  >Dengue Kits (CHC Kota)</small
                >
              </div>
            </li>
            <li style="padding: 10px; display: flex; gap: 10px">
              <span style="color: var(--royal-blue)">ü©∫</span>
              <div>
                <strong>Tele-Consult Queue</strong><br /><small
                  >14 Patients Waiting</small
                >
              </div>
            </li>
          </ul>
        </div>
      </div>

      <!-- VIEW: FIELD WORK (GRAMIN-SEVAK) -->
      <div id="view-field" class="grid-system hidden">
        <!-- NETRA LENS (NEW: REAL CAMERA) -->
        <div class="card col-6">
          <div class="card-header">
            <span class="card-title">üëÅÔ∏è Netra (Nidaan Lens)</span>
            <span class="status-badge status-online" style="font-size: 0.7rem"
              >Live Vision</span
            >
          </div>

          <!-- Lens UI -->
          <div class="lens-container" id="lens-ui">
            <video id="camera-feed" autoplay playsinline></video>
            <div class="lens-overlay"></div>
            <div class="scanner-line" id="scan-line"></div>

            <div class="lens-controls" id="lens-start-screen">
              <div style="font-size: 3rem; margin-bottom: 10px">üì∑</div>
              <p>Scan Patient Symptoms / Lab Reports</p>
              <button class="lens-btn" onclick="window.app.startCamera()">
                <span>Activate Camera</span>
              </button>
            </div>

            <!-- Result Screen -->
            <div
              id="lens-result"
              class="hidden"
              style="
                z-index: 4;
                text-align: center;
                padding: 20px;
                background: rgba(0, 0, 0, 0.85);
                width: 100%;
                position: absolute;
                bottom: 0;
              "
            >
              <div
                style="
                  color: var(--status-safe);
                  font-weight: bold;
                  font-size: 1.2rem;
                "
              >
                AI Detected: Skin Rash
              </div>
              <div style="margin: 5px 0; font-size: 0.9rem; color: #ddd">
                Confidence: 94.2% ‚Ä¢ Symptom: Erythema
              </div>
              <button
                class="lens-btn"
                onclick="window.app.resetLens()"
                style="
                  margin: 10px auto 0;
                  font-size: 0.8rem;
                  padding: 6px 15px;
                "
              >
                Close
              </button>
            </div>
          </div>

          <div style="margin-top: 15px; font-size: 0.8rem; color: #718096">
            *Powered by Divya-Drishti Vision API. Processing runs on Edge AI
            (Secure).
          </div>
        </div>

        <!-- MANUAL ENTRY WITH VOICE & AUDIO -->
        <div class="card col-6">
          <div class="card-header">
            <span class="card-title">üìù Field Report Entry</span>
          </div>
          <form onsubmit="window.app.saveReport(event)">
            <div class="input-group">
              <label class="input-label">ABHA ID / Jan Aadhaar</label>
              <input
                type="text"
                class="form-control"
                id="patient-id-input"
                placeholder="XX-XXXX-XXXX-XX"
                required
              />
            </div>
            <div class="input-group">
              <label class="input-label">Symptom Category</label>
              <select class="form-control" id="symptom-select">
                <option value="Fever">Fever (High Grade)</option>
                <option value="Respiratory">Respiratory Distress</option>
                <option value="Rash">Vector Borne (Rash/Joint Pain)</option>
              </select>
            </div>

            <!-- Voice Transcript Input -->
            <div class="input-group">
              <label class="input-label">Additional Notes (Voice/Text)</label>
              <div style="display: flex; gap: 10px">
                <textarea
                  id="voice-transcript"
                  class="form-control"
                  placeholder="Describe symptoms or use voice input..."
                  rows="3"
                  style="flex: 1"
                ></textarea>
                <button
                  type="button"
                  id="voice-input-btn"
                  class="btn-primary"
                  onclick="window.VoiceHandler.startVoiceInput('voice-transcript')"
                  style="height: fit-content; white-space: nowrap"
                >
                  üé§ Voice Input
                </button>
              </div>
              <small
                style="color: #718096; display: block; margin-top: 5px"
                id="interim-transcript"
              ></small>
            </div>

            <!-- Audio Recording -->
            <div class="input-group">
              <label class="input-label">Consultation Audio (Optional)</label>
              <div style="display: flex; gap: 10px">
                <button
                  type="button"
                  id="audio-record-btn"
                  class="btn-primary"
                  onclick="window.VoiceHandler.isRecording ? window.VoiceHandler.stopAudioRecording() : window.VoiceHandler.startAudioRecording()"
                  style="flex: 1"
                >
                  üéôÔ∏è Record Audio
                </button>
              </div>
            </div>

            <button type="submit" class="btn-primary" style="width: 100%">
              üíæ Save to Sanchay (Local Vault)
            </button>
          </form>

          <div
            style="
              margin-top: 20px;
              border-top: 1px solid #eee;
              padding-top: 10px;
            "
          >
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <span style="font-weight: 600; font-size: 0.9rem"
                >Sanchay Queue (Offline)</span
              >
              <button
                class="btn-primary"
                style="
                  padding: 5px 10px;
                  font-size: 0.8rem;
                  background: var(--status-warn);
                "
                onclick="window.app.syncToCloud()"
              >
                Sync to Megh-Kosh
              </button>
            </div>
            <div
              id="queue-list"
              style="margin-top: 10px; font-size: 0.85rem; color: #718096"
            >
              No pending records.
            </div>
          </div>
        </div>

        <!-- IMAGE UPLOAD COMPONENT (Initialized by JS) -->
        <div id="image-upload-container" class="col-12"></div>
      </div>

      <!-- VIEW: CLOUD (MEGH-KOSH - FIRESTORE REALTIME) -->
      <div id="view-cloud" class="grid-system hidden">
        <div class="card col-12">
          <div class="card-header">
            <span class="card-title"
              >‚òÅÔ∏è Megh-Kosh (The ChitraHarsha Data Cloud)</span
            >
            <span class="status-badge status-online"
              >Connected to Firestore</span
            >
          </div>
          <p style="margin-bottom: 20px; color: #4a5568">
            Live synchronization with Rajasthan State Data Centre (Simulated via
            Firestore).
          </p>
          <div style="overflow-x: auto">
            <table
              style="width: 100%; border-collapse: collapse; font-size: 0.9rem"
            >
              <thead
                style="background: #f7fafc; border-bottom: 2px solid #edf2f7"
              >
                <tr>
                  <th style="padding: 12px; text-align: left">Timestamp</th>
                  <th style="padding: 12px; text-align: left">Symptom</th>
                  <th style="padding: 12px; text-align: left">User ID</th>
                  <th style="padding: 12px; text-align: left">Status</th>
                </tr>
              </thead>
              <tbody id="cloud-table-body">
                <tr>
                  <td colspan="4" style="padding: 20px; text-align: center">
                    Loading Live Records...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <!-- FOOTER -->
    <footer>
      <h3 style="color: var(--marwar-gold); margin-bottom: 10px">
        THE CHITRAHARSHA VPK VENTURES
      </h3>
      <p>Commercial License | Approved by DoIT&C, Govt. of Rajasthan</p>

      <div class="compliance-badges">
        <span class="comp-badge">üîí ISO 27001</span>
        <span class="comp-badge">üìú DPDP Act 2023</span>
        <span class="comp-badge">üè• EHR Standards</span>
        <span class="comp-badge">‚òÅÔ∏è Meghraj Cloud</span>
      </div>
      <div style="margin-top: 15px; font-family: monospace; opacity: 0.6">
        Version 2.0.1 (Netra Update)
      </div>
    </footer>

    <!-- APP LOGIC -->
    <script type="module">
      // Firebase Setup
      const {
        initializeApp,
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
        getFirestore,
        collection,
        addDoc,
        query,
        orderBy,
        limit,
        onSnapshot,
        serverTimestamp,
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL,
      } = window.firebaseModules;

      const firebaseConfig = JSON.parse(
        new URLSearchParams(window.location.search).get("__firebase_config") ||
          "{}"
      );
      const appId = typeof __app_id !== "undefined" ? __app_id : "default-app";

      // Initialize Firebase
      let db, auth, user, storage;
      try {
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        storage = getStorage(app);
        signInAnonymously(auth).catch(console.error);
      } catch (e) {
        console.log("Firebase Init Placeholder (Run in Canvas environment)");
      }

      // Register Service Worker for PWA
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("/service-worker.js")
            .then((registration) => {
              console.log("‚úÖ ServiceWorker registered:", registration.scope);

              // Check for updates
              registration.addEventListener("updatefound", () => {
                const newWorker = registration.installing;
                newWorker.addEventListener("statechange", () => {
                  if (
                    newWorker.state === "installed" &&
                    navigator.serviceWorker.controller
                  ) {
                    console.log("üîÑ New version available! Reload to update.");
                  }
                });
              });
            })
            .catch((error) =>
              console.log("‚ùå ServiceWorker registration failed:", error)
            );
        });
      }

      // --- CORE APPLICATION LOGIC ---
      window.app = {
        state: {
          isLoggedIn: false,
          isHindi: false,
          offlineQueue: JSON.parse(
            localStorage.getItem("nidaan_queue") || "[]"
          ),
          currentUser: "Guest",
          mediaStream: null,
          currentAudio: null, // Current audio attachment
          currentImages: [], // Current image attachments
        },

        // AUTH
        toggleAuthBtn: function () {
          document.getElementById("login-btn").disabled =
            !document.getElementById("consent-check").checked;
        },

        login: function () {
          const id = document.getElementById("auth-id").value || "RJ-USER-001";
          document.getElementById("auth-overlay").style.display = "none";
          this.state.isLoggedIn = true;
          this.state.currentUser = id;
          this.refreshQueueUI();
          this.initCloudListener(); // Start listening to Firestore

          // Initialize image upload UI
          if (window.ImageHandler) {
            window.ImageHandler.initialize("image-upload-container");
          }
        },

        // Method to attach audio for saving
        attachAudio: function (audioData) {
          this.state.currentAudio = audioData;
          console.log("Audio attached to current record");
        },

        // NAVIGATION
        nav: function (tab) {
          document
            .querySelectorAll(".nav-link")
            .forEach((el) => el.classList.remove("active"));
          document.getElementById(`tab-${tab}`).classList.add("active");
          document
            .querySelectorAll(".grid-system")
            .forEach((el) => el.classList.add("hidden"));
          document.getElementById(`view-${tab}`).classList.remove("hidden");

          // Stop camera if leaving field view
          if (tab !== "field") this.stopCamera();
        },

        // LANGUAGE TOGGLE
        toggleLang: function () {
          this.state.isHindi = !this.state.isHindi;
          const set = this.state.isHindi;

          document.getElementById("tab-dash").innerText = set
            ? "‡§∞‡§æ‡§ú-‡§¶‡§∞‡•ç‡§™‡§£ (Dashboard)"
            : "Raj-Darpan (Dashboard)";
          document.getElementById("tab-field").innerText = set
            ? "‡§ó‡•ç‡§∞‡§æ‡§Æ‡•Ä‡§£-‡§∏‡•á‡§µ‡§ï (Field)"
            : "Gramin-Sevak (Field)";
          document.getElementById("tab-cloud").innerText = set
            ? "‡§Æ‡•á‡§ò-‡§ï‡•ã‡§∑ (Cloud)"
            : "Megh-Kosh (Cloud)";
          document.getElementById("prediction-title").innerText = set
            ? "‡§µ‡§æ‡§Ø‡§∞‡§≤ ‡§™‡•ç‡§∞‡§ï‡•ã‡§™ ‡§∏‡§Ç‡§≠‡§æ‡§µ‡§®‡§æ: ‡§Æ‡§ß‡•ç‡§Ø‡§Æ"
            : "Viral Outbreak Probability: Moderate";
        },

        // CAMERA (NETRA LENS)
        startCamera: async function () {
          const video = document.getElementById("camera-feed");
          const startScreen = document.getElementById("lens-start-screen");
          const scanLine = document.getElementById("scan-line");

          try {
            this.state.mediaStream = await navigator.mediaDevices.getUserMedia({
              video: { facingMode: "environment" },
            });
            video.srcObject = this.state.mediaStream;
            video.style.display = "block";
            startScreen.style.display = "none";
            scanLine.style.display = "block";

            // Simulate AI Analysis after 4 seconds
            setTimeout(() => {
              document.getElementById("lens-result").classList.remove("hidden");
              scanLine.style.display = "none";
            }, 4000);
          } catch (err) {
            alert(
              "Camera Permission Denied or Not Available. Using Manual Mode."
            );
          }
        },

        stopCamera: function () {
          if (this.state.mediaStream) {
            this.state.mediaStream.getTracks().forEach((track) => track.stop());
            this.state.mediaStream = null;
          }
          document.getElementById("camera-feed").style.display = "none";
        },

        resetLens: function () {
          document.getElementById("lens-result").classList.add("hidden");
          document.getElementById("lens-start-screen").style.display = "block";
          document.getElementById("scan-line").style.display = "none";
        },

        // DATA HANDLING (LOCAL & CLOUD)
        // DATA HANDLING (LOCAL & CLOUD)
        saveReport: async function (e) {
          e.preventDefault();
          const symptom = document.getElementById("symptom-select").value;
          let patientId = document.getElementById("patient-id-input").value;
          let notes = document.getElementById("voice-transcript").value;

          // Get attachments
          const images = window.ImageHandler
            ? window.ImageHandler.getImages()
            : [];
          const audio = this.state.currentAudio;

          // Encrypt Sensitive Data
          let isEncrypted = false;
          if (window.EncryptionService && this.state.currentUser !== "Guest") {
            try {
              // Encrypt fields
              patientId = await window.EncryptionService.encrypt(
                patientId,
                this.state.currentUser
              );
              if (notes) {
                notes = await window.EncryptionService.encrypt(
                  notes,
                  this.state.currentUser
                );
              }
              isEncrypted = true;
            } catch (err) {
              console.error("Encryption failed:", err);
            }
          }

          const record = {
            id: Date.now(),
            symptom: symptom,
            patientId: patientId, // Encrypted or plain
            notes: notes, // Encrypted or plain
            isEncrypted: isEncrypted,
            user: this.state.currentUser,
            timestamp: new Date().toISOString(),
            images: images, // Contains blob or encrypted data
            audio: audio, // Contains blob or encrypted data
            userAgent: navigator.userAgent,
          };

          this.state.offlineQueue.push(record);
          localStorage.setItem(
            "nidaan_queue",
            JSON.stringify(this.state.offlineQueue) // Note: blobs won't serialize well here without handling, but for demo simplistic approach.
            // In a real app, we'd convert blobs to base64 or IndexedDB.
            // For now, assume session persistence or simple object storage.
          );

          // Reset UI
          this.refreshQueueUI();
          e.target.reset();
          if (window.ImageHandler) window.ImageHandler.clearImages();
          if (window.VoiceHandler) window.VoiceHandler.discardAudio();
          this.state.currentAudio = null;

          alert("‚úÖ Saved to Sanchay (Local Vault) with Encryption.");
        },

        refreshQueueUI: function () {
          const list = document.getElementById("queue-list");
          const count = this.state.offlineQueue.length;
          list.innerHTML =
            count > 0
              ? `<strong>${count}</strong> Records pending upload.`
              : "No pending records.";
        },

        // FIRESTORE SYNC WITH STORAGE
        syncToCloud: async function () {
          if (this.state.offlineQueue.length === 0)
            return alert("Nothing to sync.");
          if (!db) return alert("Cloud Database not initialized.");

          // Show loading state
          const btn = document.querySelector(
            'button[onclick="window.app.syncToCloud()"]'
          );
          const originalText = btn.innerText;
          btn.innerText = "‚è≥ Syncing...";
          btn.disabled = true;

          const batch = [...this.state.offlineQueue]; // Copy array
          let successCount = 0;

          const { ref, uploadBytes, getDownloadURL } = window.firebaseModules;

          for (let i = 0; i < batch.length; i++) {
            let rec = batch[i];

            try {
              // 1. Upload Images
              let imageUrls = [];
              if (
                rec.images &&
                rec.images.length > 0 &&
                window.firebaseModules.getStorage
              ) {
                const storage = window.firebaseModules.getStorage();

                for (let img of rec.images) {
                  // Determine what to upload (blob or encrypted json blob)
                  let uploadData = img.data.data || img.data.blob;
                  let contentType = img.data.encrypted
                    ? "application/json"
                    : img.type;

                  // If it's encrypted data object, convert to blob
                  if (img.data.encrypted) {
                    uploadData = new Blob([JSON.stringify(img.data.data)], {
                      type: "application/json",
                    });
                  } else if (!uploadData && img.preview) {
                    // Fallback if blob lost in serialization (simplification)
                    uploadData = await (await fetch(img.preview)).blob();
                  }

                  const storageRef = ref(
                    storage,
                    `artifacts/${appId}/images/${rec.id}_${img.name}.json`
                  );
                  await uploadBytes(storageRef, uploadData);
                  const url = await getDownloadURL(storageRef);
                  imageUrls.push({
                    url: url,
                    name: img.name,
                    encrypted: img.data.encrypted,
                  });
                }
              }

              // 2. Upload Audio
              let audioUrl = null;
              if (rec.audio && window.firebaseModules.getStorage) {
                const storage = window.firebaseModules.getStorage();

                let uploadData = rec.audio.ciphertext
                  ? new Blob([JSON.stringify(rec.audio)], {
                      type: "application/json",
                    })
                  : rec.audio; // Assuming plain blob if not encrypted

                const storageRef = ref(
                  storage,
                  `artifacts/${appId}/audio/${rec.id}_audio.json`
                );
                await uploadBytes(storageRef, uploadData);
                audioUrl = await getDownloadURL(storageRef);
              }

              // 3. Save Metadata to Firestore
              // Remove large blobs from record before saving
              const finalRecord = { ...rec };
              delete finalRecord.images;
              delete finalRecord.audio;

              finalRecord.attachments = {
                images: imageUrls,
                audio: audioUrl,
              };

              finalRecord.syncedAt = serverTimestamp();

              await addDoc(
                collection(
                  db,
                  "artifacts",
                  appId,
                  "public",
                  "data",
                  "nidaan_records"
                ),
                finalRecord
              );

              successCount++;
            } catch (err) {
              console.error("Sync failed for record " + rec.id, err);
            }
          }

          // Cleanup
          if (successCount === batch.length) {
            this.state.offlineQueue = [];
            localStorage.setItem("nidaan_queue", "[]");
            alert(
              `‚úÖ Successfully synced ${successCount} records to Megh-Kosh.`
            );
          } else {
            // Keep failed records (simplified logic: just clear all for demo, in prod meaningful queue mgmt needed)
            this.state.offlineQueue = this.state.offlineQueue.filter(
              (_, idx) => idx >= successCount
            );
            localStorage.setItem(
              "nidaan_queue",
              JSON.stringify(this.state.offlineQueue)
            );
            alert(`‚ö†Ô∏è Synced ${successCount}/${batch.length} records.`);
          }

          this.refreshQueueUI();
          btn.innerText = originalText;
          btn.disabled = false;
        },

        // REAL-TIME LISTENER
        initCloudListener: function () {
          if (!db) return;

          const q = query(
            collection(
              db,
              "artifacts",
              appId,
              "public",
              "data",
              "nidaan_records"
            ),
            orderBy("timestamp", "desc"),
            limit(10)
          );

          onSnapshot(q, (snapshot) => {
            const tbody = document.getElementById("cloud-table-body");
            tbody.innerHTML = "";
            snapshot.forEach((doc) => {
              const data = doc.data();

              // Formatting
              const hasAudio = data.attachments?.audio ? "üéôÔ∏è" : "";
              const imgCount = data.attachments?.images?.length || 0;
              const hasImages = imgCount > 0 ? `üì∑(${imgCount})` : "";
              const locked = data.isEncrypted ? "üîí" : "";

              const row = `<tr>
                            <td style="padding:12px; border-bottom:1px solid #eee;">
                                ${new Date(data.timestamp).toLocaleTimeString()}
                            </td>
                            <td style="padding:12px; border-bottom:1px solid #eee;">
                                ${data.symptom} ${locked}
                            </td>
                            <td style="padding:12px; border-bottom:1px solid #eee;">
                                ${data.user}
                            </td>
                            <td style="padding:12px; border-bottom:1px solid #eee; color:var(--status-safe);">
                                ‚úî Synced ${hasAudio} ${hasImages}
                            </td>
                        </tr>`;
              tbody.innerHTML += row;
            });
          });
        },

        // Dummy AI update for dashboard
        updateAI: function (val) {
          // ...existing update logic...
        },
      };

      // Initial load
      window.app.refreshQueueUI();
    </script>
  </body>
</html>
